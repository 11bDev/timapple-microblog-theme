<header class="site-header">
  <div class="container">
    
    {{/* Site Masthead */}}
    <div class="site-masthead" style="text-align: center;">
      <h1 class="site-title">
        <a href="{{ .Site.BaseURL }}">{{ .Site.Title }}</a>
      </h1>
      <p class="date-banner" style="text-align: center;">{{ now.Format "Monday, January 2, 2006" }}</p>
    </div>

    {{/* Main Navigation - Uses Micro.blog's page management */}}
    <nav class="site-nav" role="navigation" aria-label="Main navigation">
      <ul>
        <li><a href="{{ .Site.BaseURL }}" {{ if .IsHome }}class="active"{{ end }}>Home</a></li>
        {{/* Dynamic pages from Micro.blog settings - sorted by Weight */}}
        {{ range sort .Site.Menus.main "Weight" }}
          <li>
            {{/* Detect active state using multiple methods */}}
            {{ $menuName := .Name }}
            {{ $menuURL := .URL }}
            {{ $currentURL := $.Page.RelPermalink }}
            {{ $pageTitle := $.Page.Title }}
            {{ $isActive := false }}
            
            {{/* Method 1: Direct URL match */}}
            {{ if eq $currentURL $menuURL }}
              {{ $isActive = true }}
            {{ end }}
            
            {{/* Method 2: URL starts with menu URL */}}
            {{ if not $isActive }}
              {{ if and (gt (len $menuURL) 1) (hasPrefix $currentURL $menuURL) }}
                {{ $isActive = true }}
              {{ end }}
            {{ end }}
            
            {{/* Method 3: Page title matches menu name exactly */}}
            {{ if not $isActive }}
              {{ if eq $pageTitle $menuName }}
                {{ $isActive = true }}
              {{ end }}
            {{ end }}
            
            {{/* Method 4: Current URL contains menu name (lowercase) - for /categories/essays/ etc */}}
            {{ if not $isActive }}
              {{ $lowerMenuName := $menuName | lower }}
              {{ $lowerURL := $currentURL | lower }}
              {{ if strings.Contains $lowerURL $lowerMenuName }}
                {{ $isActive = true }}
              {{ end }}
            {{ end }}
            
            {{/* Method 5: Check Section */}}
            {{ if not $isActive }}
              {{ $lowerMenuName := $menuName | lower }}
              {{ if eq ($.Page.Section | lower) $lowerMenuName }}
                {{ $isActive = true }}
              {{ end }}
            {{ end }}
            
            {{ if .Page.Params.redirect }}
              <a href="{{ .Page.Params.redirect }}">{{ .Name }}</a>
            {{ else }}
              <a href="{{ .URL | relLangURL | safeURL }}"{{ if $isActive }} class="active"{{ end }}>{{ .Name }}</a>
            {{ end }}
          </li>
        {{ end }}
      </ul>
    </nav>

  </div>
</header>
